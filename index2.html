<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Layout Generator Preview â€” Sidebar Layout (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --canvas-w: 1280px; --canvas-h: 720px;
    --gap: 8px; --bg:#fff; --ink:#111; --baseline:8px;
  }

  /* App split: left controls, right preview */
  html, body { height:100%; margin:0; font-family: Helvetica, Arial, sans-serif; }
  .app { height:100%; display:flex; }

  /* Left sidebar */
  .sidebar {
    width: 280px;
    background:#f9f9f9;
    border-right:1px solid #ccc;
    padding:12px;
    box-sizing:border-box;
    display:flex; flex-direction:column; gap:10px;
  }
  .sidebar h3 { margin:8px 0 4px; font-size:14px }
  .sidebar input[type=text], .sidebar select { width:100%; padding:6px; box-sizing:border-box; }
  .sidebar input[type=file] { width:100%; }
  .sidebar button { padding:6px; cursor:pointer; }

  /* Right preview panel */
  .preview {
    flex:1;
    position:relative;          /* anchor for absolute #scaler */
    background:#eee;
    overflow:hidden;
  }

  /* Absolutely centered scaler */
  #scaler{
    position:absolute;
    top:50%; left:50%;
    transform-origin: center center; /* scale around center */
  }

  /* Fixed-size canvas (true logical size) */
  #canvas{
    width: var(--canvas-w);
    height: var(--canvas-h);
    background: var(--bg);
    box-shadow: 0 6px 30px rgba(0,0,0,.15);
    padding: var(--gap);
    display:flex;
    overflow:hidden;
  }

  /* Layout engine elems */
  .row, .col { display:flex; gap:var(--gap); flex:1 1 0; min-width:0; min-height:0; }
  .col { flex-direction:column; }
  .leaf { flex:1 1 0; min-width:0; min-height:0; padding:var(--gap); overflow:hidden; }
  .text { width:100%; word-break: keep-all; overflow-wrap: normal; color: var(--ink); }
  .image { width:100%; height:100%; object-fit:cover; display:block; }
  .logo { font-weight:bold; font-size:18px; color: var(--ink); }
</style>
</head>
<body>
<div class="app">
  <!-- Left controls -->
  <div class="sidebar">
    <h3>Add Blocks</h3>
    <input id="headerText" type="text" placeholder="Header">
    <button onclick="addBlock('header')">Add Header</button>

    <input id="subheaderText" type="text" placeholder="Subheader">
    <button onclick="addBlock('subheader')">Add Subheader</button>

    <input id="bodyText" type="text" placeholder="Body">
    <button onclick="addBlock('body')">Add Body</button>

    <input id="logoText" type="text" placeholder="Logo">
    <button onclick="addBlock('logo')">Add Logo</button>

    <input id="imageFile" type="file" accept="image/*">
    <button onclick="addBlock('image')">Add Image</button>

    <h3>Format</h3>
    <select id="format">
      <option value="16-9" selected>16:9</option>
      <option value="1-1">1:1</option>
      <option value="a4">A4 Portrait</option>
      <option value="a4landscape">A4 Landscape</option>
    </select>

    <h3>Actions</h3>
    <button onclick="resetAll()">Reset</button>
    <button onclick="render()">Recompose</button>
  </div>

  <!-- Right preview -->
  <div class="preview" id="preview">
    <div id="scaler">
      <div id="canvas"></div>
    </div>
  </div>
</div>

<script>
const root   = document.documentElement;
const canvas = document.getElementById("canvas");
const scaler = document.getElementById("scaler");
const preview= document.getElementById("preview");

let blocks = [];

const SCALE = { header:72, subheader:36, body:20, logo:18 };
const BASELINE = 8;

/* ---------- Controls ---------- */
function addBlock(type){
  const id=(crypto.randomUUID)?crypto.randomUUID():("id-"+Math.random().toString(36).slice(2));
  if(type==="header"){
    blocks.push({id,type,content:document.getElementById("headerText").value||"HEADER",hero:true});
  }
  if(type==="subheader"){
    blocks.push({id,type,content:document.getElementById("subheaderText").value||"Subheader"});
  }
  if(type==="body"){
    blocks.push({id,type,content:document.getElementById("bodyText").value||"Body text"});
  }
  if(type==="logo"){
    blocks.push({id,type,content:document.getElementById("logoText").value||"LOGO"});
  }
  if(type==="image"){
    const file=document.getElementById("imageFile").files[0];
    if(file){ blocks.push({id,type,src:URL.createObjectURL(file)}); }
  }
  render();
}
function resetAll(){ blocks=[]; render(); }

/* ---------- Render & Layout ---------- */
function render(){
  canvas.innerHTML = "";
  // Always show the canvas (even if no blocks) so preview is visible
  if(blocks.length===0){
    // empty canvas still scales and centers
    scaleToPreview();
    return;
  }
  const shuffled=[...blocks].sort(()=>Math.random()-0.5);
  const dir=Math.random()<0.5?'row':'col';
  const tree=subdivide(shuffled,dir);
  canvas.appendChild(renderNode(tree));
  requestAnimationFrame(()=>{ recalcAllText(); scaleToPreview(); });
}

function subdivide(items,dir){
  if(items.length===1) return {kind:"leaf",item:items[0]};
  const hero=items.some(it=>it.hero);
  let ratio=hero?0.65:[0.5,0.382,0.618][Math.floor(Math.random()*3)];
  const sizeA=Math.max(1,Math.min(items.length-1,Math.round(items.length*ratio)));
  return {kind:"split",direction:dir,ratio,
    a:subdivide(items.slice(0,sizeA),toggle(dir)),
    b:subdivide(items.slice(sizeA),toggle(dir))};
}

function renderNode(node){
  if(node.kind==="leaf"){
    const el=document.createElement("div"); el.className="leaf";
    if(["header","subheader","body"].includes(node.item.type)){
      const t=document.createElement("div");
      t.className="text"; t.textContent=node.item.content; t.dataset.id=node.item.id;
      el.appendChild(t);
    }
    if(node.item.type==="image"){
      const img=document.createElement("img"); img.className="image"; img.src=node.item.src; el.appendChild(img);
    }
    if(node.item.type==="logo"){
      const t=document.createElement("div"); t.className="logo"; t.textContent=node.item.content; el.appendChild(t);
    }
    return el;
  }
  const wrap=document.createElement("div"); wrap.className=node.direction==="row"?"row":"col";
  const a=document.createElement("div"); a.className=node.direction==="row"?"col":"row"; a.style.flex=node.ratio;
  const b=document.createElement("div"); b.className=node.direction==="row"?"col":"row"; b.style.flex=1-node.ratio;
  a.appendChild(renderNode(node.a)); b.appendChild(renderNode(node.b));
  wrap.appendChild(a); wrap.appendChild(b); return wrap;
}

/* ---------- Type fit ---------- */
function fitText(container,el,item){
  const maxW=container.offsetWidth, maxH=container.offsetHeight;
  let fontSize=SCALE[item.type]||20;
  const set=()=>{ el.style.fontSize=fontSize+"px";
    el.style.lineHeight=Math.max(BASELINE,Math.round((fontSize*1.35)/BASELINE)*BASELINE)+"px"; };
  set();
  let guard=140;
  while(guard-- > 0 && (el.scrollWidth>maxW || el.scrollHeight>maxH) && fontSize>4){
    fontSize--; set();
  }
}
function recalcAllText(){
  canvas.querySelectorAll(".text").forEach(el=>{
    const block=blocks.find(b=>b.id===el.dataset.id);
    if(block) fitText(el.parentElement,el,block);
  });
}

/* ---------- Scaling (uses actual preview pane size) ---------- */
function scaleToPreview(){
  const vw = preview.clientWidth;     // width of the right pane
  const vh = preview.clientHeight;    // height of the right pane
  const cw = canvas.offsetWidth;      // logical canvas size
  const ch = canvas.offsetHeight;
  if(!vw || !vh || !cw || !ch) return;

  const s = Math.min(vw / cw, vh / ch, 1); // only scale down
  scaler.style.width = cw + "px";
  scaler.style.height = ch + "px";
  scaler.style.transform = `translate(-50%, -50%) scale(${s})`;
}

/* ---------- Format chooser ---------- */
function setFormat(fmt){
  let w=1280,h=720;
  if(fmt==="1-1"){w=900;h=900;}
  if(fmt==="a4"){w=794;h=1123;}
  if(fmt==="a4landscape"){w=1123;h=794;}
  root.style.setProperty("--canvas-w", w+"px");
  root.style.setProperty("--canvas-h", h+"px");
  scaleToPreview();
}
document.getElementById("format").addEventListener("change", e=>setFormat(e.target.value));

/* ---------- Helpers ---------- */
function toggle(d){ return d==='row' ? 'col' : 'row'; }

/* Keep preview correct on resize */
window.addEventListener("resize", scaleToPreview);

/* Init */
setFormat(document.getElementById("format").value);
render();
</script>
</body>
</html>